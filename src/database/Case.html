## 1. CASE 문 기본

- **CASE 문**: SQL의 조건부 로직 (IF-THEN-ELSE 역할)
- 데이터를 조건에 따라 가공하거나 새로운 의미를 부여할 수 있음

### 종류

1. **단순 CASE (Simple CASE)**
- 특정 컬럼 값에 따라 분기
```sql
CASE status
WHEN 'PENDING' THEN '주문 대기'
WHEN 'COMPLETED' THEN '결제 완료'
ELSE '알 수 없음'
END as statusXXX
```

2. **검색 CASE (Searched CASE)**

- `WHEN` 절에 독립적인 조건식 사용
```sql
CASE
WHEN price >= 100000 THEN '고가'
WHEN price >= 30000  THEN '중가'
ELSE '저가'
END as priceXXX
```
- **조건은 위에서부터 순차적으로 평가** → 먼저 만족하는 조건이 실행됨

## 2. CASE 문 주의사항

- CASE 문은 **위에서부터 조건을 평가**하고, **처음으로 만족하는 조건**에서 멈춘다.
- 따라서 **상세하고 제한적인 조건(=범위가 좁음)**을 먼저 쓰고,
**포괄적이고 넓은 조건**은 뒤에 배치해야 한다.
- 사용 가능 위치:
- `SELECT` (표현식)
- `ORDER BY` (정렬 기준)
- `GROUP BY` (그룹핑 기준)
- `WHERE` (조건식)

- 잘못된 예시
```sql
CASE
WHEN price >= 30000 THEN '중가'   -- 먼저 걸려버림
WHEN price >= 100000 THEN '고가'
ELSE '저가'
END
```
- 올바른 예시
```sql
CASE
WHEN price >= 100000 THEN '고가'  -- 더 구체적인 조건을 먼저
WHEN price >= 30000 THEN '중가'
ELSE '저가'
END
```

- 즉, **조건이 겹칠 수 있다면 “더 강한 조건 → 더 약한 조건” 순서로 배치해야 한다**라고 이해하면 된다.

## 3. CASE 문 ORDER BY

```sql
select name,
case
when price >= 100000 then '고가'
when price >= 30000 then '중가'
else '저가'
end as price_label
from products
order by
CASE
WHEN price >= 100000 THEN 1
WHEN price >= 30000 THEN 2
ELSE 3
END asc, price desc -- 오름차순은 보통 생략
```

## 4. CASE 문과 그룹핑

- **CASE + GROUP BY** = 새로운 분류 기준으로 집계 가능
```sql
SELECT
CASE
WHEN YEAR(birth_date) >= 1990 THEN '1990년대생'
WHEN YEAR(birth_date) >= 1980 THEN '1980년대생'
ELSE '그 이전 출생'
END AS birth_decade,
COUNT(*) AS customer_count
FROM users
GROUP BY birth_decade;
```
- 원칙적으로는 `GROUP BY` 절이 `SELECT` 절 보다 먼저 처리되기 때문에 사용이 불가능하지만, `MySQL`을 포함한 최신 버전의 많은 데이터베이스에서 이 기능을 지원한다.

## 5. 조건부 집계 (Conditional Aggregation)

- `CASE`를 **집계 함수 내부**에 사용
- Pivot Table 형식 보고서 작성 가능
### 패턴

1. `COUNT(CASE ...)`
```sql
COUNT(CASE WHEN status = 'COMPLETED' THEN 1 END)
```

2. SUM(CASE ...)
```sql
SUM(CASE WHEN status = 'COMPLETED' THEN 1 ELSE 0 END)
```

- 예시: 주문 상태별 카운트
```sql
select count(*) as total_orders,
count(case when status = 'COMPLETED' then 1 end) as complted_count,
count(case when status = 'SHIPPED' then 1 end) as shipped_count,
count(case when status = 'PENDING' then 1 end) as pending_count
from orders;

-- 또는 SUM 집계 함수를 통해서도 가능

SELECT
COUNT(*) AS total_orders,
SUM(CASE WHEN status = 'COMPLETED' THEN 1 ELSE 0 END) AS completed_count,
SUM(CASE WHEN status = 'SHIPPED' THEN 1 ELSE 0 END) AS shipped_count,
SUM(CASE WHEN status = 'PENDING' THEN 1 ELSE 0 END) AS pending_count
FROM orders;
```
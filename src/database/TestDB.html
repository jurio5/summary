### 데이터베이스 분리

- 기본적으로 테스트를 함에 앞서 가장 중요한 건 `격리성`을 보장해야하는 것이다. 기존에 메인에서 사용을 하던 데이터베이스 테이블을 테스트 환경에서 그대로 사용하게 되면, 기본적으로 테스트 코드도 메모리에 저장을 하지 않는 이상, DB 접근 기술을 통해 데이터베이스의 정보를 토대로 테스트를 진행하게 된다.
- 그렇다면, 이런 부분들의 `격리성`을 보장하기 위해선 테스트 환경과 실제 프로덕션 환경의 데이터베이스를 서로 다르게 격리를 시켜주면 된다.
- 스프링의 서블릿 컨테이너는 `profile`을 기준으로 동작을 하게 되는데, 보통 이 `profile`마다 DB를 다르게 분포를 해줌으로써 이 문제를 간단하게 해결할 수 있다.
- 스프링은 빈에 `DataSource`와`TransactionManager`를 자동으로 등록하여 실행한다.
- 이런 과정에서 직접 `TransactionManager`를 설정하지 않으면, 자동으로 스프링에서 `HikariCP`같은 커넥션 풀을 이용하며 자동으로 커넥션을 관리하게 된다.
- 스프링에서 지원하는 이 같은 내용들을 사용하고 싶다면, 환경설정 파일에 DB 관련 정보들을 기입하면 그 내용들을 스프링이 읽어서 자동으로 관리한다.


![[@Transactional.jpg]]

### 테스트의 주요 원칙
- 테스트는 다른 테스트와 격리해야 한다.
- 테스트는 반복해서 실행할 수 있어야 한다.


### @Transactional

- `Transactional`어노테이션은 로직이 정상적으로 성공하면 `commit`을 하게된다. 그러나, 이 `Transactional`어노테이션은 테스트 환경에서는 특별하게 동작을 하는데, 이 어노테이션이 테스트 환경에 있으면, 스프링은 테스트를 트랜잭션 안에서 실행을 시킨 뒤 자동으로 `Rollback`을 시킨다.

- 이 내용들은 트랜잭션 ACID 성질의 격리성과 유사하지만, 조금 다른 맥락으로 사용이 되는데 `테스트는 다른 테스트와 격리해야 한다.`라는 부분에서의 격리성은 테스트마다 서로 영향을 주지 않도록 분리된 환경에서 실행되어야 한다. 라는 의미로 쓰인다.
- `Transactional`어노테이션을 테스트 환경에서 사용하려면 꼭, `SpringBootTest`어노테이션이 붙은 즉, 통합 테스트 환경에서만 자동으로 롤백을 해주는데 조금만 생각을 해보면 저 통합 테스트 자체가 애플리케이션을 실행시켜서 실제와 유사한 환경에서 테스트를 한다는 의미로, 스프링 빈이 관리하지 않는 환경에서는 트랜잭션 어노테이션의 의미가 퇴색될 수 있다. 이 부분은 트랜잭션 매니저가 스프링 빈에 의해 관리되고 있으며, 커넥션 또한 트랜잭션 매니저가 트랜잭션 동기화 매니저에 커넥션을 전달 후 만들어주고, 레포지터리에선 그 동기화 된 커넥션을 기준으로 데이터를 다루기 때문에 문제가 될 수 있다.
- 단위 테스트의 경우에는 트랜잭션 매니저를 직접 만들어준 뒤 커넥션을 연결 후 상태를 관리하여 롤백까지 수동으로 진행하면 된다. (`BeforeEach`, `AfterEach`)


### 임베디드 모드

- 보통 `dev`,`prod` 등 여러가지 모드로 나눠서 개발을 하며, `dev` 모드에선 `H2 DB`를 사용하고, `prod` 모드에선 `MySQL`을 사용하는 등 이러한 방법으로 격리성을 나눠두긴 하지만, 이 이외에 규모가 아주 작고 간단한 방식으로 테스트 환경에서 격리성을 유지하기 위해선 또 다른 DB를 새로 생성해서 두 개의 DB를 유지하며 번거롭게 테스트를 진행해야 한다.
- 이런 부분을 해결하기 위해서 `H2` 같은 경우는 자체적으로 메모리 모드를 지원하게 되는데, 이걸 임베디드 모드라고 부르며, 간단하게 애플리케이션 실행 시 프로필만 테스트로 등록을 해준 뒤 `H2` 전용 `DataSource`즉, 커넥션을 만들고 `schema.sql`을 따로 테스트 환경의 리소스 쪽에 삽입하여 쿼리문을 작성 후 사용하면 간편하게 `H2`를 띄우지 않고도 사용을 할 수 있다.
- 그러나, 이렇게 수동으로 임베디드 모드를 띄우지 않아도, 스프링은 내부적으로 자동으로 임베디드 모드를 만들어서 처리를 해 주는데, `DataSource`를 만들어 커넥션을 유지하는 이런 행위나, `test`디렉터리의 리소스 내부에 환경설정에서 데이터베이스 정보를 설정하는 이런 일련의 과정을 다 제거하면 스프링에서 자동으로 권한을 위임받아 임베디드 모드를 사용하게 해준다.
- 물론 이 부분은 `schema.sql`이 테스트 환경설정 부분에 포함되어 있어야한다.